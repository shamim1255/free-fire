<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FF TournX</title>
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- SwiperJS for Slider -->
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <style>
        :root {
            --primary-bg: #1a023e; --secondary-bg: #2a0b68; --card-bg: #3c1e7a;
            --text-primary: #ffffff; --text-secondary: #a7a2b0; --accent-green: #00D27A;
            --accent-blue: #009cff; --active-nav-bg: #5D3E71; --danger-red: #e53e3e;
            --gold: #FFD700; --silver: #C0C0C0; --bronze: #CD7F32; --warning: #ffc107;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--primary-bg); display: flex; justify-content: center; align-items: center; color: var(--text-primary); }
        .hidden { display: none !important; }
        .mobile-screen { width: 100%; max-width: 414px; height: 100%; max-height: 850px; background-color: var(--primary-bg); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; display: flex; flex-direction: column; overflow: hidden; }
        
        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 2, 62, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            color: var(--text-secondary);
            transition: opacity 0.3s ease;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--card-bg);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #page-container { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding-bottom: 90px; 
            scroll-behavior: smooth; 
        }
        #page-container::-webkit-scrollbar { display: none; }
        
        .page-padding { padding: 0 20px; }
        .page-header { display: flex; align-items: center; padding: 20px; }
        .page-header h1 { font-size: 1.3rem; font-weight: 600; flex-grow: 1; margin-left:10px; }
        .back-btn { background: none; border: none; color: white; cursor: pointer; }
        .back-btn .material-icons { font-size: 28px; }
        
        #auth-page { padding: 25px; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        #auth-page h1 { font-size: 1.8rem; margin-bottom: 30px; text-align:center; }
        #auth-page .input-group { width: 100%; margin-bottom: 18px; }
        #auth-page .input-field { width: 100%; padding: 15px; background-color: var(--secondary-bg); border: 1px solid var(--active-nav-bg); border-radius: 10px; color: var(--text-primary); font-size: 1rem; }
        #auth-page .submit-btn { width: 100%; padding: 15px; margin-top: 10px; background-color: var(--accent-blue); border: none; border-radius: 10px; color: white; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        #auth-page .auth-toggle { margin-top: 25px; color: var(--text-secondary); font-size: 0.9rem; text-align:center;}
        #auth-page .auth-toggle span { color: var(--accent-green); font-weight: 600; cursor: pointer; }

        .home-header { display: flex; align-items: center; padding: 20px; }
        .profile-pic { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent-green); cursor: pointer; }
        .user-info { margin-left: 15px; flex-grow: 1; cursor: pointer; }
        .user-info h2 { font-size: 1.1rem; margin: 0; font-weight: 600; }
        .user-info p { font-size: 0.8rem; color: var(--text-secondary); margin: 0; }
        .wallet-balance { display: flex; align-items: center; padding: 8px 12px; background-color: var(--accent-green); color:black; border-radius: 25px; font-weight: bold; cursor:pointer; font-size: 0.9rem; }
        .header-icon-btn { background: none; border: none; color: white; cursor: pointer; padding-left: 15px; }
        .header-icon-btn .material-icons { font-size: 26px; }
        .swiper-container { width:100%; padding-bottom:30px; margin-top:10px; margin-bottom: 25px; }
        .swiper-slide { border-radius: 12px; overflow: hidden; cursor: pointer; aspect-ratio: 16/9; background-color: var(--secondary-bg); display:flex; align-items:center; justify-content:center; }
        .swiper-slide img { width: 100%; height: 100%; object-fit: cover; }
        .swiper-pagination-bullet-active { background-color: var(--accent-green) !important; }
        .home-page-title { padding: 0 20px 15px 20px; font-size: 1.2rem; font-weight: 600; }
        
        #tournaments-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            padding: 0 20px;
        }
        .tournament-card { background-color: var(--secondary-bg); border-radius: 15px; padding: 10px; text-align: center; cursor: pointer; }
        .tournament-card img { width: 100%; border-radius: 10px; aspect-ratio: 1/1; object-fit: cover; }
        .tournament-card h4 { margin-top: 10px; font-weight: 500; font-size: 1rem; }
        .tournament-card p { font-size: 0.8rem; color: var(--text-secondary); }

        .profile-stats-card { background-color: var(--card-bg); border-radius: 20px; padding: 25px; }
        .profile-card-header { display: flex; align-items: center; margin-bottom: 30px; flex-direction: column; justify-content: center; gap: 10px; }
        .profile-card-user-info { flex-grow: 1; text-align: center; }
        .profile-card-user-info h2 { font-size: 1.8rem; font-weight: 600; margin: 0 0 5px 0; }
        .profile-card-user-info p { font-size: 1rem; color: var(--text-secondary); margin: 0; }
        .edit-profile-btn { background-color: white; color: var(--primary-bg); width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; flex-shrink: 0; margin-left: 15px; }
        .edit-profile-btn .material-icons { font-size: 18px; }
        
        .profile-stats-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .stat-item { background-color: var(--primary-bg); padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 15px; }
        .stat-item .material-icons { font-size: 36px; color: var(--accent-green); }
        .stat-item-text { display:flex; flex-direction:column; }
        .stat-item-label { font-size: 0.9rem; color: var(--text-secondary); }
        .stat-item-value { font-size: 1.5rem; font-weight: 600; }
        #logout-btn { display: block; width: calc(100% - 40px); margin: 20px auto; background: var(--danger-red); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 600; font-size: 1rem; cursor: pointer; }

        .wallet-card { background-color: var(--card-bg); border-radius: 15px; margin: 0 20px 20px 20px; padding: 20px; }
        .wallet-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--secondary-bg); }
        .wallet-row:last-child { border-bottom: none; }
        .wallet-row .info h3 { font-size: 1.2rem; } .wallet-row .info p { font-size: 0.8rem; color: var(--text-secondary); }
        .wallet-btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; }
        .btn-green { background-color: var(--accent-green); color: black; } .btn-purple { background-color: #7952B3; color: white; }
        .amount-input-box { margin: 20px 20px 0 20px; display: flex; align-items: center; background: var(--secondary-bg); padding: 10px 15px; border-radius: 10px; }
        .amount-input-box span { font-size: 1.5rem; margin-right: 10px; }
        .amount-input-box input { flex-grow: 1; background: none; border: none; color: white; font-size: 1.5rem; width: 100%; }
        .primary-btn { display: block; width: calc(100% - 40px); margin: 20px; padding: 15px; background: var(--accent-green); color: black; border-radius: 10px; text-align: center; font-weight: 600; border:none; cursor: pointer; font-size: 1.1rem; }
        .input-field-dark { width: 100%; padding: 15px; background-color: var(--secondary-bg); border: 1px solid var(--card-bg); border-radius: 10px; color: var(--text-primary); font-size: 1rem; margin-bottom: 15px; }
        
        .payment-info-card { background-color: var(--secondary-bg); border-radius: 15px; margin: 20px; padding: 20px; }
        .payment-info-card h3 { text-align: center; margin-bottom: 20px; }
        .payment-method-logo { display: block; margin: 0 auto 20px auto; height: 40px; }
        .payment-instruction-box { background-color: var(--primary-bg); color: var(--text-secondary); padding: 15px; border-radius: 10px; border: 1px solid var(--card-bg); }
        .payment-instruction-box p { margin: 0; font-size: 0.9rem; white-space: pre-wrap; line-height: 1.6; }
        .payment-number-box { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 8px; margin-top: 15px; }
        .payment-number-box span { font-size: 1.2rem; font-weight: 600; letter-spacing: 1px; }
        .copy-btn { background: none; border: none; color: white; cursor: pointer; }

        .transaction-list { display: flex; flex-direction: column; gap: 10px; padding: 0 20px; }
        .transaction-item { display: flex; align-items: center; background-color: var(--card-bg); padding: 15px; border-radius: 10px; }
        .transaction-icon { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 15px; }
        .transaction-icon.credit { background-color: rgba(0, 210, 122, 0.2); color: var(--accent-green); }
        .transaction-icon.debit { background-color: rgba(229, 62, 62, 0.2); color: var(--danger-red); }
        .transaction-details { flex-grow: 1; }
        .transaction-details p { margin: 0; font-size: 1rem; font-weight: 500; }
        .transaction-details span { font-size: 0.8rem; color: var(--text-secondary); }
        .transaction-amount { font-weight: 600; font-size: 1.1rem; }
        .transaction-amount.credit { color: var(--accent-green); }
        .transaction-amount.debit { color: var(--danger-red); }

        .match-card { background-color: var(--secondary-bg); border-radius: 15px; margin: 0 20px 20px; padding: 15px; position: relative; }
        .match-card.time-over { background: linear-gradient(rgba(42, 11, 104, 0.8), rgba(229, 62, 62, 0.2)), var(--secondary-bg); }
        .match-header { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .match-header-info { flex-grow: 1; }
        .match-header-info h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 2px; }
        .match-header-info p { font-size: 0.8rem; color: var(--text-secondary); }
        .match-id-badge { font-size: 0.8rem; font-weight: bold; background-color: var(--warning); color: black; padding: 3px 8px; border-radius: 5px; }
        .match-status-badge { font-size: 0.8rem; font-weight: bold; background-color: var(--danger-red); color: white; padding: 3px 8px; border-radius: 5px; }
        .match-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; margin-bottom: 15px; }
        .stat-box p { font-size: 0.8rem; color: var(--text-secondary); }
        .stat-box h4 { font-size: 1rem; font-weight: 600; }
        .spots-progress-bar { width: 100%; height: 10px; background-color: var(--primary-bg); border-radius: 5px; overflow: hidden; margin-bottom: 5px; }
        .spots-progress { height: 100%; background-color: var(--accent-green); width: 0%; transition: width 0.3s; }
        .spots-text { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 15px; }
        .match-actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .match-action-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--card-bg); background: var(--card-bg); color: white; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.8rem; }
        .match-details-content { background-color: var(--primary-bg); padding: 15px; border-radius: 10px; margin-top: 10px; }
        .match-details-content h5 { font-size: 1rem; margin-bottom: 10px; border-bottom: 1px solid var(--secondary-bg); padding-bottom: 5px; }
        .match-details-content ul { list-style: none; padding-left: 0; }
        .match-details-content li { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; }
        .match-footer { display: flex; flex-direction: column; align-items: stretch; gap: 10px; margin-top: 15px; border-top: 1px solid var(--card-bg); padding-top: 15px; }
        .countdown-timer-wrapper { display: flex; align-items: center; justify-content: center; background-color: var(--accent-green); color: black; padding: 10px 15px; border-radius: 8px; font-weight: 600; gap: 8px; }
        .countdown-timer-wrapper .material-icons { font-size: 20px; }
        .join-btn { background-color: var(--accent-blue); color: white; padding: 12px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; font-size: 1rem; text-align: center; }
        .join-btn:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
        .remove-match-btn { position: absolute; top: 10px; right: 10px; background-color: var(--danger-red); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 5; }
        #no-more-matches, #no-my-matches, #no-transactions { text-align: center; padding: 25px; background-color: var(--card-bg); border-radius: 10px; margin: 20px; color: var(--text-secondary); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content-wrapper { background-color: var(--card-bg); color: var(--text-primary); border-radius: 20px; padding: 20px; width: 90%; max-width: 380px; position: relative; }
        .prize-modal { background-color: #ffc107; color: #333; }
        .close-modal-btn { position: absolute; top: -15px; right: -15px; background: white; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer; }
        .close-modal-btn .material-icons { color: #333; font-size: 24px; }
        .modal-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid var(--secondary-bg); padding-bottom: 15px; }
        .prize-modal .modal-header { border-bottom: 1px solid rgba(0,0,0,0.1); }
        .modal-header h4 { font-size: 1.3rem; font-weight: 700; margin-bottom: 5px; }
        .modal-header p { font-size: 0.9rem; color: var(--text-secondary); }
        .prize-modal .modal-header p { color: #555; }
        .modal-list { list-style: none; padding-left: 0; max-height: 40vh; overflow-y: auto; }
        .modal-list::-webkit-scrollbar { width: 4px; }
        .modal-list::-webkit-scrollbar-thumb { background: var(--accent-green); border-radius: 4px; }
        .modal-list li { display: flex; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--secondary-bg); }
        .prize-modal .modal-list li { border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 1rem; font-weight: 500; }
        .modal-list li:last-child { border-bottom: none; }
        .prize-list .icon { width: 24px; margin-right: 15px; }
        .prize-list .prize-value { margin-left: auto; font-weight: 700; }
        .results-list .rank { font-weight: 700; font-size: 1.1rem; width: 30px; text-align: center; margin-right: 15px; }
        .results-list .rank-1, .results-list .rank-2, .results-list .rank-3 { color: var(--gold); }
        .results-list .player-info { flex-grow: 1; }
        .results-list .player-info .name { font-weight: 600; font-size: 1rem; }
        .results-list .player-info .details { font-size: 0.8rem; color: var(--text-secondary); }
        .results-list .prize { font-weight: 700; font-size: 1rem; color: var(--accent-green); }
        .players-list .player-ingame-name { font-weight: 500; }

        .join-page-card { background: var(--secondary-bg); color: var(--text-primary); border-radius: 15px; padding: 25px; text-align: center; margin: 0 20px; }
        .join-page-details { display: flex; justify-content: space-around; margin: 20px 0; padding: 15px 0; border-top: 1px dashed var(--card-bg); border-bottom: 1px dashed var(--card-bg); }
        .join-page-details div { flex: 1; }
        .join-page-details h4 { font-size: 1.1rem; }
        .join-page-details p { font-size: 0.8rem; color: #999; }
        .join-instruction { color: var(--warning); font-weight: 500; margin: 20px 0; font-size: 0.9rem; }
        .join-inputs-container { display: flex; flex-direction: column; gap: 15px; }
        .join-now-btn { width: 100%; padding: 15px; background: var(--accent-blue); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-top: 20px; }
        
        .form-group-withdraw { margin-top: 20px; }
        .form-group-withdraw label { display: block; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px; padding-left: 5px; }
        .payment-method-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .payment-method-option { padding: 10px; background-color: var(--secondary-bg); border: 2px solid var(--secondary-bg); border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.2s ease; }
        .payment-method-option img { height: 30px; margin-bottom: 5px; object-fit: contain; }
        .payment-method-option span { font-weight: 500; font-size: 0.9rem; }
        .payment-method-option.selected { border-color: var(--accent-green); background-color: var(--card-bg); }
        .withdraw-info-box { margin-top: 30px; padding: 15px; background-color: var(--secondary-bg); color: var(--text-secondary); border-radius: 10px; font-size: 0.85rem; line-height: 1.5; }
        .withdraw-info-box strong { color: var(--accent-green); }

        .settings-list { padding: 0 10px; }
        .settings-section-header { color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; padding: 25px 10px 10px 10px; text-transform: uppercase; }
        .settings-item { display: flex; align-items: center; padding: 15px 10px; cursor: pointer; border-radius: 8px; transition: background-color 0.2s; background-color: var(--card-bg); margin-bottom: 10px; }
        .settings-item:hover { background-color: var(--secondary-bg); }
        .settings-item .material-icons { margin-right: 20px; color: var(--text-secondary); }
        .settings-item .material-icons.chevron { margin-left: auto; color: var(--text-secondary); }
        .settings-item span { font-size: 1rem; font-weight: 500; flex-grow: 1; }
        .settings-item img { width: 30px; height: 30px; margin-right: 20px; object-fit: contain; }
        .settings-version { text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-top: 30px; }

        #leaderboard-list { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; padding: 0 20px; }
        .leaderboard-item { display: flex; align-items: center; background-color: var(--card-bg); padding: 15px; border-radius: 10px; border-left: 5px solid; }
        .rank-1 { border-color: var(--gold); } .rank-2 { border-color: var(--silver); } .rank-3 { border-color: var(--bronze); }
        .leaderboard-item .rank-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 1.2rem; margin-right: 15px; color:black; }
        .rank-1 .rank-circle { background: var(--gold); } .rank-2 .rank-circle { background: var(--silver); } .rank-3 .rank-circle { background: var(--bronze); color:white;}
        .leaderboard-info { flex-grow: 1; }
        .leaderboard-info h4 { margin: 0; font-size: 1.1rem; }
        .leaderboard-info p { margin: 0; color: var(--accent-green); font-weight: 600; }

        .bottom-nav { position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background-color: var(--secondary-bg); padding: 10px 5px; border-top: 1px solid var(--card-bg); z-index:100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-secondary); cursor: pointer; font-size: 0.75rem; text-decoration: none; flex: 1; padding: 5px 0; }
        .nav-item.active { color: var(--text-primary); font-weight: 600; }
        .nav-item .nav-icon-wrapper { padding: 4px 18px; border-radius: 12px; margin-bottom: 5px; transition: background-color 0.2s; }
        .nav-item.active .nav-icon-wrapper { background-color: var(--active-nav-bg); }
        .fab { position: absolute; bottom: 90px; right: 20px; width: 56px; height: 56px; background-color: #0084ff; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 10; }
        .fab .material-icons { font-size: 28px; color: white; transform: scaleX(-1); }

        /* START: NEW CSS FOR AVATAR SELECTION */
        #avatar-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            padding-top: 10px;
        }
        .selectable-avatar {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .selectable-avatar:hover {
            border-color: var(--accent-green);
            transform: scale(1.05);
        }
        /* END: NEW CSS FOR AVATAR SELECTION */

    </style>
</head>
<body>
    <div class="mobile-screen">
        
        <div id="loading-overlay" class="hidden">
            <div class="spinner"></div>
            <p>Loading Data...</p>
        </div>

        <div id="auth-page" class="page-container"></div>
        <div id="main-app" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
            <div id="page-container">
                <!-- HOME PAGE -->
                <div id="home-page" class="app-page">
                    <header class="home-header">
                        <img id="home-profile-pic" src="" class="profile-pic" onclick="navigateTo('profile-page')">
                        <div class="user-info" onclick="navigateTo('profile-page')">
                            <h2 id="home-user-name"></h2><p>View Profile 76</p>
                        </div>
                        <div class="wallet-balance" onclick="navigateTo('wallet-page');"><span id="home-wallet-balance"></span></div>
                        <button class="header-icon-btn" onclick="navigateTo('settings-page')"><i class="material-icons">settings</i></button>
                    </header>
                    <div class="swiper-container">
                        <div class="swiper-wrapper" id="slider-wrapper"></div><div class="swiper-pagination"></div>
                    </div>
                    <h3 class="home-page-title">All Tournaments</h3>
                    <div id="tournaments-grid"></div>
                </div>

                <!-- PROFILE PAGE -->
                <div id="profile-page" class="app-page hidden">
                   <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>Profile</h1></header>
                   <div class="page-padding">
                       <div class="profile-stats-card">
                           <!-- START: MODIFIED PROFILE HEADER FOR AVATAR SELECTION -->
                           <div class="profile-card-header">
                                <div style="position: relative;">
                                    <img id="profile-page-pic" src="" class="profile-pic" style="width: 90px; height: 90px; border-width: 3px;">
                                    <div onclick="openAvatarSelectionModal()" style="position: absolute; bottom: 0; right: 0; background: white; color: var(--primary-bg); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--primary-bg); box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                                        <i class="material-icons" style="font-size: 18px;">edit</i>
                                    </div>
                                    <!-- The file input is removed from here -->
                                </div>
                                <div class="profile-card-user-info">
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                        <h2 id="profile-page-name"></h2>
                                        <div class="edit-profile-btn" style="position: static; width: 28px; height: 28px; margin: 0;" onclick="openEditProfileModal()">
                                            <i class="material-icons" style="font-size: 16px;">edit</i>
                                        </div>
                                    </div>
                                    <p id="profile-page-email" style="margin-top: 5px;"></p>
                                </div>
                           </div>
                           <!-- END: MODIFIED PROFILE HEADER -->
                           <div class="profile-stats-grid">
                               <div class="stat-item"><i class="material-icons">sports_esports</i><div class="stat-item-text"><span class="stat-item-label">Battle Played</span><h3 class="stat-item-value" id="profile-battle-played">0</h3></div></div>
                               <div class="stat-item"><i class="material-icons">emoji_events</i><div class="stat-item-text"><span class="stat-item-label">Game Level</span><h3 class="stat-item-value" id="profile-game-level">1</h3></div></div>
                               <div class="stat-item"><i class="material-icons">monetization_on</i><div class="stat-item-text"><span class="stat-item-label">Lifetime Winning</span><h3 class="stat-item-value" id="profile-lifetime-winning">110</h3></div></div>
                           </div>
                       </div>
                       <button id="logout-btn" onclick="auth.signOut()">Logout</button>
                   </div>
                </div>

                <!-- LEADERBOARD PAGE -->
                <div id="leaderboard-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>Weekly Leaderboard</h1></header>
                    <div id="leaderboard-list"></div>
                </div>

                <!-- WALLET PAGE -->
                <div id="wallet-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>Wallet</h1></header>
                    <div class="wallet-card">
                        <div class="wallet-row"><div class="info"><p>Total Balance</p><h3 id="wallet-total"></h3></div><button class="wallet-btn btn-purple" onclick="navigateTo('transactions-page')">Transactions</button></div>
                        <div class="wallet-row"><div class="info"><p>Deposit Balance</p><h3 id="wallet-deposit"></h3></div><button class="wallet-btn btn-green" onclick="navigateTo('add-cash-page')">ADD CASH</button></div>
                        <div class="wallet-row"><div class="info"><p>Winnings Balance</p><h3 id="wallet-winnings"></h3></div><button class="wallet-btn btn-purple" onclick="navigateTo('withdraw-page')">WITHDRAW</button></div>
                    </div>
                </div>

                <!-- WITHDRAW PAGE -->
                <div id="withdraw-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>Withdraw</h1></header>
                    <div class="page-padding">
                        <div class="wallet-card" style="margin: 0 0 20px 0;">
                            <div class="wallet-row" style="border-bottom:none; padding: 0;">
                                <div class="info">
                                    <p>Available for Withdrawal</p>
                                    <h3 id="withdraw-winnings-balance">110.00</h3>
                                </div>
                                <div style="text-align: right;">
                                    <p>Minimum Withdrawal</p>
                                    <h3 id="withdraw-min-amount">11100.00</h3>
                                </div>
                            </div>
                        </div>
                
                        <div class="form-group-withdraw">
                            <label for="withdraw-amount-input">Amount to Withdraw</label>
                            <div class="amount-input-box" style="margin:0;">
                                <span>11</span>
                                <input type="number" id="withdraw-amount-input" placeholder="Enter Amount">
                            </div>
                        </div>
                
                        <div class="form-group-withdraw">
                            <label>Select Method</label>
                            <div class="payment-method-selector" id="withdraw-methods-container">
                                <!-- Methods will be injected by JS -->
                            </div>
                        </div>
                        
                        <div class="form-group-withdraw">
                            <label id="withdraw-account-label" for="withdraw-account-input">Account Details</label>
                            <input type="text" id="withdraw-account-input" class="input-field-dark" placeholder="Enter your account number">
                        </div>
                
                        <button class="primary-btn" style="margin: 20px 0;" onclick="processWithdrawRequest()">Submit Request</button>
                
                        <div class="withdraw-info-box">
                            <p><strong>Note:</strong> 12181518141112 1918-1118 12191619171714 1215131317 17181718 1812171317 1318101718 1218161814 1417151118 1213131317 17111611 121212131318 1318171617, 17181718 13171217 19 171814131314191012 18141313161312 12121316 1618191217 1818141718</p>
                        </div>
                    </div>
                </div>

                <!-- TRANSACTIONS PAGE -->
                <div id="transactions-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>Transaction History</h1></header>
                    <div class="transaction-list" id="transaction-list-container">
                        <div id="no-transactions" class="hidden">No transactions found.</div>
                    </div>
                </div>

                <!-- ADD CASH PAGE -->
                <div id="add-cash-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>Add Cash</h1></header>
                    <div class="amount-input-box"><span>11</span><input type="number" id="add-cash-amount" placeholder="Enter Amount"></div>
                    <button class="primary-btn" onclick="proceedToPaymentOptions()">Proceed to Add Cash</button>
                </div>
                
                <!-- PAYMENT OPTIONS PAGE -->
                <div id="payment-options-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>Select Payment Option</h1></header>
                    <div class="page-padding">
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Amount to be added: <strong id="payment-option-amount" style="color:white;"></strong></p>
                        <div id="payment-options-container"></div>
                    </div>
                </div>

                <!-- DYNAMIC PAYMENT PAGE -->
                <div id="dynamic-payment-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1 id="dynamic-payment-header">Payment</h1></header>
                    <div class="payment-info-card">
                         <img src="" alt="Payment Method" id="payment-method-logo" class="payment-method-logo">
                         <p style="text-align:center; font-size: 1.2rem; margin-bottom:20px;">Amount: <strong id="payment-page-amount"></strong></p>
                         <div class="payment-number-box">
                             <span id="payment-agent-number"></span>
                             <button class="copy-btn" onclick="copyToClipboard(document.getElementById('payment-agent-number').innerText)"><i class="material-icons">content_copy</i></button>
                         </div>
                         <div class="payment-instruction-box" style="margin-top:20px;">
                            <p id="payment-instructions-text"></p>
                         </div>
                    </div>
                    <div class="page-padding">
                        <input type="text" id="payment-trx-id" class="input-field-dark" placeholder="Enter Transaction ID">
                        <button class="primary-btn" onclick="submitDepositRequest()">Confirm Payment</button>
                    </div>
                </div>

                <!-- MATCHES LIST PAGE -->
                <div id="matches-list-page" class="app-page hidden">
                   <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1 id="matches-list-header"></h1></header>
                   <div id="matches-list-container"></div>
                </div>

                <!-- MY MATCHES PAGE -->
                <div id="my-matches-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>My Matches</h1></header>
                    <div id="my-matches-container">
                        <div id="no-my-matches" class="hidden">You haven't joined any matches yet.</div>
                    </div>
                </div>

                <!-- JOIN MATCH PAGE -->
                <div id="join-match-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>Join Match</h1></header>
                    <div id="join-match-container"></div>
                </div>

                <!-- SETTINGS PAGE -->
                <div id="settings-page" class="app-page hidden">
                    <header class="page-header"><button class="back-btn" onclick="goBack()"><i class="material-icons">arrow_back</i></button><h1>Settings</h1></header>
                    <div class="settings-list page-padding">
                        <p class="settings-section-header">Support</p>
                        <div class="settings-item" id="support-link-facebook"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b9/2023_Facebook_icon.svg" alt="Facebook"><span>Join Facebook Group</span></div>
                        <div class="settings-item" id="support-link-telegram"><img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram"><span>Join Telegram Group</span></div>
                        <div class="settings-item" id="support-link-messenger"><img src="https://upload.wikimedia.org/wikipedia/commons/b/be/Facebook_Messenger_logo_2020.svg" alt="Messenger"><span>Facebook Messenger</span></div>
                        <p class="settings-section-header">Account</p>
                        <div class="settings-item" onclick="auth.signOut()"><i class="material-icons">logout</i><span>Log Out</span></div>
                        <p class="settings-version">Version: 1.8.0</p>
                    </div>
                </div>
            </div>
            <div id="fab-messenger" class="fab"><i class="material-icons">message</i></div>
            <nav class="bottom-nav">
                <a class="nav-item active" data-page="home-page"><div class="nav-icon-wrapper"><i class="material-icons">home</i></div><span>Home</span></a>
                <a class="nav-item" data-page="my-matches-page"><div class="nav-icon-wrapper"><i class="material-icons">style</i></div><span>My Matches</span></a>
                <a class="nav-item" data-page="leaderboard-page"><div class="nav-icon-wrapper"><i class="material-icons">leaderboard</i></div><span>Leaderboard</span></a>
                <a class="nav-item" data-page="wallet-page"><div class="nav-icon-wrapper"><i class="material-icons">account_balance_wallet</i></div><span>Wallet</span></a>
            </nav>
        </div>
        
        <!-- MODALS -->
        <div id="prize-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content-wrapper prize-modal"><button class="close-modal-btn" onclick="this.parentElement.parentElement.classList.add('hidden')"><i class="material-icons">close</i></button><div id="prize-modal-content"></div></div>
        </div>
        <div id="results-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content-wrapper"><button class="close-modal-btn" onclick="this.parentElement.parentElement.classList.add('hidden')"><i class="material-icons">close</i></button><div id="results-modal-content"></div></div>
        </div>
        <div id="players-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content-wrapper"><button class="close-modal-btn" onclick="this.parentElement.parentElement.classList.add('hidden')"><i class="material-icons">close</i></button><div id="players-modal-content"></div></div>
        </div>
        
        <div id="edit-profile-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content-wrapper">
                <button class="close-modal-btn" onclick="this.parentElement.parentElement.classList.add('hidden')"><i class="material-icons">close</i></button>
                <div class="modal-header">
                    <h4>Edit Profile</h4>
                </div>
                <form id="edit-profile-form" onsubmit="handleProfileUpdate(event)">
                    <div class="input-group">
                        <label for="edit-profile-name" style="color:var(--text-secondary); margin-bottom: 8px; display:block;">Full Name</label>
                        <input type="text" id="edit-profile-name" class="input-field-dark" required>
                    </div>
                    <div class="input-group">
                        <label for="edit-profile-password" style="color:var(--text-secondary); margin-bottom: 8px; display:block;">New Password (leave blank to keep current)</label>
                        <input type="password" id="edit-profile-password" class="input-field-dark">
                    </div>
                    <button type="submit" class="primary-btn" style="width: 100%; margin: 20px 0 0 0;">Save Changes</button>
                </form>
            </div>
        </div>

        <!-- START: NEW AVATAR SELECTION MODAL -->
        <div id="avatar-selection-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content-wrapper">
                <button class="close-modal-btn" onclick="this.parentElement.parentElement.classList.add('hidden')"><i class="material-icons">close</i></button>
                <div class="modal-header">
                    <h4>Select Your Avatar</h4>
                    <p>Choose an avatar from the list below.</p>
                </div>
                <div id="avatar-selection-grid">
                    <!-- Avatars will be loaded here by JavaScript -->
                </div>
            </div>
        </div>
        <!-- END: NEW AVATAR SELECTION MODAL -->

    </div>

<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
    // --- FIREBASE CONFIG (UPDATED) ---
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDdw4TVOMG6fsPsw1LUN4st60-utIASH_s",
      authDomain: "tournament-application-6f0e8.firebaseapp.com",
      databaseURL: "https://tournament-application-6f0e8-default-rtdb.firebaseio.com",
      projectId: "tournament-application-6f0e8",
      storageBucket: "tournament-application-6f0e8.appspot.com",
      messagingSenderId: "543678159446",
      appId: "1:543678159446:web:446e19d9c2fef68e0cf9f7",
      measurementId: "G-M82Y85VRX0"
    };
    
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();
    
    // --- GLOBAL STATE ---
    let currentUserData = null;
    let appConfig = {};
    let pageHistory = ['home-page'];
    let countdownIntervals = {};
    let tempTransactionData = {};
    let selectedWithdrawMethod = null;
    let localHiddenMatches = JSON.parse(localStorage.getItem('hiddenMatches')) || [];
    const DEFAULT_AVATAR = "https://i.postimg.cc/hPTTMRyn/images-1-22.jpg";
    
    const loadingOverlay = document.getElementById('loading-overlay');

    // --- NAVIGATION ---
    const pageContainer = document.getElementById('page-container');
    function navigateTo(pageId) {
        if (pageId !== pageHistory[pageHistory.length - 1]) pageHistory.push(pageId);
        _showPage(pageId);
    }
    function goBack() {
        if (pageHistory.length > 1) { pageHistory.pop(); _showPage(pageHistory[pageHistory.length - 1]); }
    }
    function _showPage(pageId) {
        document.querySelectorAll('.app-page').forEach(p => p.classList.add('hidden'));
        const page = document.getElementById(pageId);
        if (page) { page.classList.remove('hidden'); } else { document.getElementById('home-page').classList.remove('hidden'); }
        document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
        if (pageContainer) pageContainer.scrollTop = 0;
        
        if (pageId === 'leaderboard-page') loadLeaderboard();
        if (pageId === 'my-matches-page') loadMyMatches();
        if (pageId === 'transactions-page') loadTransactionHistory();
        if (pageId === 'withdraw-page') loadWithdrawPage();
    }
    document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', e => { e.preventDefault(); navigateTo(item.dataset.page); }));

    // --- AUTHENTICATION ---
    auth.onAuthStateChanged(user => {
        const authPage = document.getElementById('auth-page');
        const mainApp = document.getElementById('main-app');
        if (user) {
            loadingOverlay.classList.remove('hidden'); // Show loader
            mainApp.classList.remove('hidden');
            authPage.classList.add('hidden');
            loadInitialData(user.uid);
        } else {
            mainApp.classList.add('hidden');
            authPage.classList.remove('hidden');
            loadingOverlay.classList.add('hidden'); // Hide loader on logout
            currentUserData = null; // Clear old data
            authPage.innerHTML = `<form id="signin-form"><h1>Welcome Back!</h1><div class="input-group"><input type="email" id="signin-email" class="input-field" placeholder="Email" required></div><div class="input-group"><input type="password" id="signin-password" class="input-field" placeholder="Password" required></div><button type="submit" class="submit-btn">Sign In</button><p class="auth-toggle">Don't have an account? <span id="show-signup">Sign Up</span></p></form><form id="signup-form" class="hidden"><h1>Create Account</h1><div class="input-group"><input type="text" id="signup-name" class="input-field" placeholder="Full Name" required></div><div class="input-group"><input type="email" id="signup-email" class="input-field" placeholder="Email" required></div><div class="input-group"><input type="password" id="signup-password" class="input-field" placeholder="Password" required></div><button type="submit" class="submit-btn">Sign Up</button><p class="auth-toggle">Already have an account? <span id="show-signin">Sign In</span></p></form>`;
            setupAuthEventListeners();
        }
    });

    function setupAuthEventListeners() {
        document.getElementById('signup-form')?.addEventListener('submit', e => { e.preventDefault(); const name = document.getElementById('signup-name').value; const email = document.getElementById('signup-email').value; auth.createUserWithEmailAndPassword(email, document.getElementById('signup-password').value).then(cred => db.ref('users/' + cred.user.uid).set({ name, email, profilePicUrl: DEFAULT_AVATAR, walletBalance: 0, deposit: 0, winnings: 0, lifetimeWinning: 0, battlePlayed: 0, gameLevel: 1, totalRefer: 0 })).catch(err => alert(err.message)); });
        document.getElementById('signin-form')?.addEventListener('submit', e => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('signin-email').value, document.getElementById('signin-password').value).catch(err => alert(err.message)); });
        
        document.getElementById('show-signup')?.addEventListener('click', () => { 
            document.getElementById('signin-form')?.classList.add('hidden'); 
            document.getElementById('signup-form')?.classList.remove('hidden'); 
        });
        document.getElementById('show-signin')?.addEventListener('click', () => { 
            document.getElementById('signup-form')?.classList.add('hidden'); 
            document.getElementById('signin-form')?.classList.remove('hidden'); 
        });
    }

    // --- DATA LOADING & UI UPDATES ---
    function loadInitialData(uid) {
        const userRef = db.ref('users/' + uid);
        const appConfigRef = db.ref('appConfig');

        Promise.all([
            userRef.once('value'),
            appConfigRef.once('value')
        ]).then(([userSnapshot, configSnapshot]) => {
            if (userSnapshot.exists()) {
                currentUserData = { uid: userSnapshot.key, ...userSnapshot.val() };
                if (configSnapshot.exists()) {
                    appConfig = configSnapshot.val();
                }
                
                updateAllUI(currentUserData);
                loadSupportLinks();
                loadSlider();
                loadTournaments();
                navigateTo('home-page');
                
                userRef.on('value', snap => {
                    currentUserData = { uid: snap.key, ...snap.val() };
                    updateAllUI(currentUserData);
                });

                loadingOverlay.classList.add('hidden');
            } else {
                loadingOverlay.classList.add('hidden');
                alert("User data not found in database.");
                auth.signOut();
            }
        }).catch(error => {
            console.error("Error fetching initial data:", error);
            alert("Failed to load app data. Please check your connection.");
            loadingOverlay.classList.add('hidden');
        });
    }

    function updateAllUI(userData) {
        if (!userData) return;
        const formatBalance = (val) => `11${parseFloat(val || 0).toFixed(2)}`;
        const avatarUrl = userData.profilePicUrl || DEFAULT_AVATAR;

        document.getElementById('home-user-name').textContent = userData.name;
        document.getElementById('home-profile-pic').src = avatarUrl;
        document.getElementById('home-wallet-balance').textContent = formatBalance(userData.walletBalance);

        const profilePagePic = document.getElementById('profile-page-pic');
        if (profilePagePic) profilePagePic.src = avatarUrl;
        
        document.getElementById('profile-page-name').textContent = userData.name;
        document.getElementById('profile-page-email').textContent = userData.email;
        document.getElementById('profile-battle-played').textContent = userData.battlePlayed || 0;
        document.getElementById('profile-game-level').textContent = userData.gameLevel || 1;
        document.getElementById('profile-lifetime-winning').textContent = formatBalance(userData.lifetimeWinning);
        
        document.getElementById('wallet-total').textContent = formatBalance(userData.walletBalance);
        document.getElementById('wallet-deposit').textContent = formatBalance(userData.deposit);
        document.getElementById('wallet-winnings').textContent = formatBalance(userData.winnings);
    }
    
    function loadSupportLinks() {
        const defaultLinks = { facebook: "#", telegram: "#", messenger: "#" };
        const links = appConfig.supportLinks ? { ...defaultLinks, ...appConfig.supportLinks } : defaultLinks;
    
        const openLink = (url) => { if(url && url !== '#') window.open(url, '_blank'); };

        const fab = document.getElementById('fab-messenger');
        if (links.messenger && links.messenger !== '#' && fab) { 
            fab.onclick = () => openLink(links.messenger);
            fab.classList.remove('hidden'); 
        } else { 
            fab?.classList.add('hidden'); 
        }
        
        document.getElementById('support-link-facebook').onclick = () => openLink(links.facebook);
        document.getElementById('support-link-telegram').onclick = () => openLink(links.telegram);
        document.getElementById('support-link-messenger').onclick = () => openLink(links.messenger);
    }

    // --- START: NEW AND MODIFIED PROFILE FUNCTIONS FOR AVATAR SELECTION ---
    function openAvatarSelectionModal() {
        const modal = document.getElementById('avatar-selection-modal-overlay');
        const grid = document.getElementById('avatar-selection-grid');
        modal.classList.remove('hidden');
        grid.innerHTML = `<p>Loading avatars...</p>`;

        // Admin needs to add avatar URLs under appConfig/avatars in Firebase
        db.ref('appConfig/avatars').once('value', snapshot => {
            if (snapshot.exists()) {
                grid.innerHTML = '';
                snapshot.forEach(child => {
                    const avatarUrl = child.val();
                    const img = document.createElement('img');
                    img.src = avatarUrl;
                    img.className = 'selectable-avatar';
                    img.alt = 'Avatar';
                    img.onclick = () => selectAvatar(avatarUrl);
                    grid.appendChild(img);
                });
            } else {
                grid.innerHTML = `<p>No custom avatars available.</p>`;
            }
        }).catch(error => {
            console.error("Error fetching avatars:", error);
            grid.innerHTML = `<p style="color:var(--danger-red);">Could not load avatars.</p>`;
        });
    }
    
    async function selectAvatar(avatarUrl) {
        if (!auth.currentUser) return alert("You must be logged in.");
        
        const loadingP = loadingOverlay.querySelector('p');
        loadingP.textContent = "Updating Avatar...";
        loadingOverlay.classList.remove('hidden');

        try {
            await db.ref(`users/${auth.currentUser.uid}`).update({ profilePicUrl: avatarUrl });
            alert("Avatar updated successfully!");
            document.getElementById('avatar-selection-modal-overlay').classList.add('hidden');
        } catch (error) {
            console.error("Avatar update error:", error);
            alert("Failed to update avatar. Please try again.");
        } finally {
            loadingOverlay.classList.add('hidden');
            loadingP.textContent = "Loading Data...";
        }
    }

    function openEditProfileModal() {
        if (!currentUserData) return;
        document.getElementById('edit-profile-name').value = currentUserData.name || '';
        document.getElementById('edit-profile-password').value = '';
        document.getElementById('edit-profile-modal-overlay').classList.remove('hidden');
    }

    async function handleProfileUpdate(event) {
        event.preventDefault();
        const newName = document.getElementById('edit-profile-name').value.trim();
        const newPassword = document.getElementById('edit-profile-password').value;

        if (!newName) {
            alert("Name cannot be empty.");
            return;
        }

        loadingOverlay.classList.remove('hidden');

        try {
            await db.ref(`users/${auth.currentUser.uid}`).update({ name: newName });
            if (newPassword && newPassword.length >= 6) {
                await auth.currentUser.updatePassword(newPassword);
                alert("Profile and password updated successfully!");
            } else if (newPassword) {
                alert("Password must be at least 6 characters long. Name was updated, but password was not.");
            } else {
                alert("Profile name updated successfully!");
            }
            
            document.getElementById('edit-profile-modal-overlay').classList.add('hidden');
        } catch (error) {
            console.error("Profile update error:", error);
            alert(`Failed to update profile. Error: ${error.message}\n\nYou may need to log out and log back in to change your password.`);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }
    // --- END: NEW AND MODIFIED PROFILE FUNCTIONS ---

    function loadSlider() {
        const sliderWrapper = document.getElementById('slider-wrapper');
        db.ref('sliders').on('value', snapshot => {
            if(!sliderWrapper) return;
            sliderWrapper.innerHTML = '';
            if (!snapshot.exists()) return;
            snapshot.forEach(child => {
                const slide = child.val();
                sliderWrapper.innerHTML += `<div class="swiper-slide" onclick="${slide.actionUrl ? `window.open('${slide.actionUrl}', '_blank')` : ''}"><img src="${slide.imageUrl}" alt="Promo"></div>`;
            });
            if (snapshot.numChildren() > 0) {
                 new Swiper('.swiper-container', { loop: snapshot.numChildren() > 1, autoplay: { delay: 3000 }, pagination: { el: '.swiper-pagination', clickable: true } });
            }
        });
    }

    function loadTournaments() {
        const grid = document.getElementById('tournaments-grid');
        db.ref('tournaments').on('value', snap => {
            if(!grid) return;
            grid.innerHTML = '';
            if (!snap.exists()) { 
                grid.innerHTML = '<p style="text-align:center;color:var(--text-secondary); padding:20px; grid-column: 1 / -1;">No tournaments available.</p>'; 
                return; 
            }
            snap.forEach(child => {
                const tourId = child.key;
                const tour = child.val();
                const matchCount = tour.matches ? Object.keys(tour.matches).filter(mId => tour.matches[mId].status !== 'completed').length : 0;
                const matchText = matchCount > 0 ? `${matchCount} matches found` : 'No active matches';
                grid.innerHTML += `<div class="tournament-card" onclick="showMatchesListPage('${tourId}', '${tour.name.replace(/'/g, "\\'")}')">
                                      <img src="${tour.imageUrl}" alt="${tour.name}">
                                      <h4>${tour.name}</h4>
                                      <p>${matchText}</p>
                                   </div>`;
            });
        });
    }

    function showMatchesListPage(tourId, tourName) {
        navigateTo('matches-list-page');
        document.getElementById('matches-list-header').textContent = `${tourName} Matches`;
        const container = document.getElementById('matches-list-container');
        container.innerHTML = '<p style="text-align:center; padding: 20px;">Loading matches...</p>';
        
        db.ref(`tournaments/${tourId}/matches`).orderByChild('date').on('value', snapshot => {
            container.innerHTML = '';
            Object.values(countdownIntervals).forEach(clearInterval);
            countdownIntervals = {};
            if (!snapshot.exists()) { container.innerHTML = '<div id="no-more-matches">No upcoming matches in this tournament.</div>'; return; }
            
            const matches = [];
            snapshot.forEach(child => {
                matches.push({ tourId: tourId, matchId: child.key, ...child.val() });
            });

            if(matches.length === 0){
                 container.innerHTML = '<div id="no-more-matches">No upcoming matches in this tournament.</div>'; return;
            }

            matches.reverse();
            matches.forEach(match => container.appendChild(createMatchCard(match.tourId, match.matchId, match)));
        });
    }

    function createMatchCard(tourId, matchId, match, isMyMatchPage = false) {
        const userId = auth.currentUser ? auth.currentUser.uid : null;
        const isJoined = userId && match.joinedPlayers && match.joinedPlayers[userId];
        const joinedCount = match.joinedPlayers ? Object.keys(match.joinedPlayers).length : 0;
        const progress = (match.maxPlayers > 0) ? (joinedCount / match.maxPlayers) * 100 : 0;
        const totalPrize = Object.values(match.prizeDetails || {}).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
        const isTimeOver = !match.isStarted && new Date(match.date).getTime() < Date.now();
        const isRemovable = isMyMatchPage && (match.status === 'completed' || isTimeOver);

        const card = document.createElement('div');
        card.className = 'match-card';
        if (isTimeOver && match.status !== 'completed') {
            card.classList.add('time-over');
        }
        card.id = `match-card-${matchId}`;

        let headerBadges = `<span class="match-id-badge">ID: ${matchId.slice(-4).toUpperCase()}</span>`;
        if (isTimeOver && match.status !== 'completed') {
            headerBadges += `<span class="match-status-badge" style="margin-left:5px;">Time Over</span>`;
        }

        card.innerHTML = `
            ${isRemovable ? `<button class="remove-match-btn" onclick="hideMatchFromMyList('${matchId}')"><i class="material-icons">delete</i></button>` : ''}
            <div class="match-header">
                <div class="match-header-info"><h3>${match.name}</h3><p>${new Date(match.date).toLocaleString()}</p></div>
                <div>${headerBadges}</div>
            </div>
            <div class="match-stats">
                <div class="stat-box"><p>WIN PRIZE</p><h4>11${totalPrize}</h4></div>
                <div class="stat-box"><p>PER KILL</p><h4>11${match.perKill || 0}</h4></div>
                <div class="stat-box"><p>ENTRY FEE</p><h4>11${match.entryFee}</h4></div>
            </div>
            <div class="spots-progress-bar"><div class="spots-progress" style="width: ${progress}%;"></div></div>
            <div class="spots-text"><span>${joinedCount}/${match.maxPlayers} spots filled</span><span>Only ${match.maxPlayers - joinedCount} spots left</span></div>
            <div class="match-actions">
                <button class="match-action-btn" onclick="toggleRoomDetails('${tourId}', '${matchId}')"><i class="material-icons">vpn_key</i> Room ID</button>
                <button class="match-action-btn" onclick="showPrizeModalWrapper('${tourId}', '${matchId}')"><i class="material-icons">emoji_events</i> Prizes</button>
                <button class="match-action-btn" onclick="showJoinedPlayers('${tourId}', '${matchId}')"><i class="material-icons">people</i> Players (${joinedCount})</button>
            </div>
            <div class="match-details-content hidden" id="details-content-${matchId}"></div>
            <div class="match-footer">
                ${
                    match.status === 'completed'
                    ? `<button class="join-btn" style="background-color: var(--accent-green); color:black;" onclick="showMatchResults('${tourId}', '${matchId}')">View Results</button>`
                    : `
                        <div class="countdown-timer-wrapper" id="timer-wrapper-${matchId}"><i class="material-icons">timer</i><span id="timer-${matchId}">Loading...</span></div>
                        <button class="join-btn" id="join-btn-${matchId}" ${isJoined || progress >= 100 || isTimeOver ? 'disabled' : ''} onclick="navigateTo('join-match-page'); showJoinPage('${tourId}', '${matchId}')">
                            ${isJoined ? 'Joined' : (isTimeOver ? 'Closed' : (progress >= 100 ? 'Full' : 'Join Now'))}
                        </button>
                    `
                }
            </div>
        `;
        if (match.status !== 'completed') {
            startCountdown(matchId, match.date, match.status, match.isStarted);
        }
        return card;
    }
    
    function startCountdown(matchId, endTimeStr, matchStatus, isStarted) {
        if (countdownIntervals[matchId]) clearInterval(countdownIntervals[matchId]);
        const intervalId = setInterval(() => {
            const timerElement = document.getElementById(`timer-${matchId}`);
            if (!timerElement) { clearInterval(intervalId); return; }

            const distance = new Date(endTimeStr).getTime() - new Date().getTime();
            const joinButton = document.getElementById(`join-btn-${matchId}`);

            if (distance < 0 || isStarted) {
                clearInterval(intervalId);
                timerElement.textContent = isStarted ? "Match Started" : "Match Time Over";
                const wrapper = document.getElementById(`timer-wrapper-${matchId}`);
                if (wrapper) wrapper.style.backgroundColor = 'var(--danger-red)';
                if (joinButton && !joinButton.disabled) { joinButton.textContent = "Closed"; joinButton.disabled = true; }
                if(distance < 0 && pageHistory[pageHistory.length - 1] === 'my-matches-page') {
                    loadMyMatches();
                }
                return;
            }
            const h = String(Math.floor((distance / (1000*60*60)) % 24)).padStart(2,'0');
            const m = String(Math.floor((distance / (1000*60)) % 60)).padStart(2,'0');
            const s = String(Math.floor((distance / 1000) % 60)).padStart(2,'0');
            timerElement.textContent = `Starts In: ${h}h ${m}m ${s}s`;
        }, 1000);
        countdownIntervals[matchId] = intervalId;
    }

    function hideMatchFromMyList(matchId) {
        if(confirm("Are you sure you want to remove this match from your list?")) {
            if(!localHiddenMatches.includes(matchId)) {
                localHiddenMatches.push(matchId);
                localStorage.setItem('hiddenMatches', JSON.stringify(localHiddenMatches));
            }
            loadMyMatches();
        }
    }
    
    function showPrizeModalWrapper(tourId, matchId) {
        db.ref(`tournaments/${tourId}/matches/${matchId}`).once('value', snapshot => {
            if (!snapshot.exists()) return alert("Match details not found.");
            const match = snapshot.val();
            const totalPrize = Object.values(match.prizeDetails || {}).reduce((sum, val) => sum + (parseFloat(val) || 0), 0);
            showPrizeModal(match.prizeDetails || {}, match.perKill || 0, match.name, totalPrize);
        });
    }

    function showPrizeModal(prizeDetails, perKill, matchName, totalPrize) {
        const modal = document.getElementById('prize-modal-overlay');
        const modalContent = document.getElementById('prize-modal-content');
        let prizeListHTML = Object.entries(prizeDetails)
            .sort((a,b) => parseInt(a[0].match(/\d+/)) - parseInt(b[0].match(/\d+/)))
            .map(([key, value]) => `<li>#${key.charAt(0).toUpperCase() + key.slice(1)} <span class="prize-value">11${value}</span></li>`)
            .join('');
        prizeListHTML += `<li>Per Kill <span class="prize-value">11${perKill || 0}</span></li>`;

        modalContent.innerHTML = `<div class="modal-header"><h4>WINNING PRIZE</h4><p>${matchName}</p></div><ul class="modal-list prize-list">${prizeListHTML}</ul><div class="total-prize-pool"><i class="material-icons icon">workspace_premium</i> Total Prize Pool: 11${totalPrize || 0}</div>`;
        modal.classList.remove('hidden');
    }

    function showMatchResults(tourId, matchId) {
        db.ref(`tournaments/${tourId}/matches/${matchId}`).once('value', snapshot => {
            if (!snapshot.exists()) return alert("Match results not found.");
            const match = snapshot.val();
            const results = match.results || {};
            const modal = document.getElementById('results-modal-overlay');
            const modalContent = document.getElementById('results-modal-content');
            
            let resultsHTML = Object.values(results)
                .sort((a,b) => (parseInt(a.rank) || 99) - (parseInt(b.rank) || 99))
                .map(res => `
                    <li class="results-list">
                        <span class="rank rank-${res.rank}">${res.rank}</span>
                        <div class="player-info">
                            <div class="name">${res.userName}</div>
                            <div class="details">Kills: ${res.kills} 61 In-Game: ${res.inGameName}</div>
                        </div>
                        <span class="prize">+ 11${res.prize.toFixed(2)}</span>
                    </li>
                `).join('');
            
            if (!resultsHTML) resultsHTML = '<li>No results published yet.</li>';
            
            modalContent.innerHTML = `<div class="modal-header"><h4>Match Results</h4><p>${match.name}</p></div><ul class="modal-list results-list">${resultsHTML}</ul>`;
            modal.classList.remove('hidden');
        });
    }
    
    function showJoinedPlayers(tourId, matchId) {
        db.ref(`tournaments/${tourId}/matches/${matchId}`).once('value', snapshot => {
            if (!snapshot.exists()) return alert("Match details not found.");
            const match = snapshot.val();
            const players = match.joinedPlayers || {};
            const modal = document.getElementById('players-modal-overlay');
            const modalContent = document.getElementById('players-modal-content');

            let playersHTML = Object.values(players)
                .map(p => `<li class="players-list"><span class="player-ingame-name">${p.inGameName}</span></li>`)
                .join('');
            if (!playersHTML) playersHTML = '<li>No players have joined yet.</li>';
            
            modalContent.innerHTML = `<div class="modal-header"><h4>Joined Players (${Object.keys(players).length})</h4><p>${match.name}</p></div><ul class="modal-list players-list">${playersHTML}</ul>`;
            modal.classList.remove('hidden');
        });
    }

    function toggleRoomDetails(tourId, matchId) {
        const detailsContent = document.getElementById(`details-content-${matchId}`);
        if (!detailsContent) return;
        const isHidden = detailsContent.classList.contains('hidden');
        if (!isHidden) { detailsContent.classList.add('hidden'); return; }

        const userId = auth.currentUser.uid;
        detailsContent.innerHTML = `<p>Loading details...</p>`;
        detailsContent.classList.remove('hidden');

        db.ref(`tournaments/${tourId}/matches/${matchId}`).once('value', snapshot => {
            if (!snapshot.exists()) { detailsContent.innerHTML = `<p>Error loading match details.</p>`; return; }
            const match = snapshot.val();
            const isJoined = match.joinedPlayers && match.joinedPlayers[userId];
            const showTime = new Date(match.date).getTime() - (10 * 60 * 1000); 
            const credentialsVisible = match.isStarted || Date.now() > showTime;

            if (isJoined && credentialsVisible) {
                detailsContent.innerHTML = `<h5><i class="material-icons" style="font-size: 1.2rem; vertical-align: bottom;">vpn_key</i> Room Credentials</h5><ul><li>Room ID: <strong style="color:white;">${match.roomID || 'TBA'}</strong></li><li>Password: <strong style="color:white;">${match.roomPassword || 'TBA'}</strong></li></ul>`;
            } else if (isJoined) {
                 detailsContent.innerHTML = `<p style="color: var(--accent-blue);">Room ID and Password will be shown 10 minutes before the match starts.</p>`;
            } else {
                detailsContent.innerHTML = `<p style="color: var(--warning);">Please join the match to view Room ID and Password.</p>`;
            }
        });
    }
    
    function showJoinPage(tourId, matchId) {
        const container = document.getElementById('join-match-container');
        container.innerHTML = `<p style="text-align:center; padding: 20px;">Loading...</p>`;
        db.ref(`tournaments/${tourId}/matches/${matchId}`).once('value', snapshot => {
            if (!snapshot.exists()) { container.innerHTML = '<p>Match not found.</p>'; return; }
            const match = snapshot.val();
            let totalPrize = Object.values(match.prizeDetails || {}).reduce((s, v) => s + (parseFloat(v) || 0), 0);
            container.innerHTML = `<div class="join-page-card"><h3>${match.name}</h3><div class="join-page-details"><div><p>Win Prize</p><h4>11${totalPrize}</h4></div><div><p>Entry Fee</p><h4>11${match.entryFee}</h4></div></div><p class="join-instruction">*1218161814 1917121714 1618121719 14191117 14111716 1714111618</p><input type="text" id="player_ingame_name" class="input-field-dark" placeholder="Enter Your In-Game Name" required><button class="join-now-btn" onclick="processJoinMatch('${tourId}', '${matchId}', ${match.entryFee})">Join Now!</button></div>`;
        });
    }

    function processJoinMatch(tourId, matchId, entryFee) {
        const inGameName = document.getElementById('player_ingame_name')?.value.trim();
        if (!inGameName) return alert('Please enter your in-game name.');
        
        const user = auth.currentUser;
        if (!user || !currentUserData) return alert("Critical error: User data not available. Please restart the app.");
        if (currentUserData.walletBalance < entryFee) { alert("Insufficient balance."); navigateTo('add-cash-page'); return; }

        const matchRef = db.ref(`tournaments/${tourId}/matches/${matchId}`);
        matchRef.transaction(match => {
            if (match) {
                if (match.isStarted || new Date(match.date).getTime() < Date.now()) return; 
                if (match.joinedPlayers && match.joinedPlayers[user.uid]) return; 
                const joinedCount = match.joinedPlayers ? Object.keys(match.joinedPlayers).length : 0;
                if (joinedCount >= match.maxPlayers) return;
                if (!match.joinedPlayers) match.joinedPlayers = {};
                match.joinedPlayers[user.uid] = { inGameName: inGameName, joinedAt: firebase.database.ServerValue.TIMESTAMP };
            }
            return match;
        }, (error, committed, snapshot) => {
            if (error) { alert('Failed to join. Please try again.'); }
            else if (!committed) { alert('Could not join. Match might be full, has already started, or you have already joined.'); }
            else {
                const newBalance = currentUserData.walletBalance - entryFee;
                const depositDeduction = Math.min(currentUserData.deposit, entryFee);
                const winningDeduction = entryFee - depositDeduction;
                const updates = {};
                updates[`/users/${user.uid}/walletBalance`] = newBalance;
                updates[`/users/${user.uid}/battlePlayed`] = (currentUserData.battlePlayed || 0) + 1;
                if (depositDeduction > 0) updates[`/users/${user.uid}/deposit`] = currentUserData.deposit - depositDeduction;
                if (winningDeduction > 0) updates[`/users/${user.uid}/winnings`] = currentUserData.winnings - winningDeduction;
                db.ref().update(updates);
                db.ref(`userTransactions/${user.uid}`).push({ amount: -entryFee, details: `Joined: ${snapshot.val().name}`, timestamp: firebase.database.ServerValue.TIMESTAMP });
                alert('Successfully joined the match!');
                goBack();
            }
        });
    }
    
    function proceedToPaymentOptions() {
        const amount = parseFloat(document.getElementById('add-cash-amount').value);
        const minDeposit = appConfig?.paymentSettings?.minDeposit || 50;
        if (isNaN(amount) || amount < minDeposit) return alert(`Minimum deposit is 11${minDeposit}.`);
        tempTransactionData.amount = amount;
        document.getElementById('payment-option-amount').textContent = `11${amount.toFixed(2)}`;
        showPaymentOptions();
    }
    
    function showPaymentOptions() {
        const container = document.getElementById('payment-options-container');
        container.innerHTML = `<p>Loading payment methods...</p>`;
        db.ref('paymentMethods').once('value', snapshot => {
            if (!snapshot.exists()) { container.innerHTML = `<p>No payment methods available.</p>`; return; }
            container.innerHTML = '';
            snapshot.forEach(child => {
                const method = child.val();
                const item = document.createElement('div');
                item.className = 'settings-item';
                item.onclick = () => showDynamicPaymentPage(method);
                item.innerHTML = `<img src="${method.logo}" alt="${method.name}"><span>${method.name}</span><i class="material-icons chevron">chevron_right</i>`;
                container.appendChild(item);
            });
            navigateTo('payment-options-page');
        });
    }
    
    function showDynamicPaymentPage(method) {
        tempTransactionData.methodName = method.name;
        document.getElementById('dynamic-payment-header').textContent = `${method.name} Payment`;
        document.getElementById('payment-method-logo').src = method.logo;
        document.getElementById('payment-page-amount').textContent = `11${tempTransactionData.amount.toFixed(2)}`;
        document.getElementById('payment-agent-number').textContent = method.number;
        document.getElementById('payment-instructions-text').textContent = method.instructions;
        document.getElementById('payment-trx-id').value = '';
        navigateTo('dynamic-payment-page');
    }

    function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => alert('Number copied!')); }

    function submitDepositRequest() {
        const trxId = document.getElementById('payment-trx-id').value.trim();
        if (!trxId) return alert("Please enter Transaction ID.");
        db.ref('depositRequests').push({
            userId: auth.currentUser.uid, userName: currentUserData.name, amount: tempTransactionData.amount, 
            methodName: tempTransactionData.methodName, transactionId: trxId,
            status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            alert("Your request has been submitted. It will be processed shortly.");
            navigateTo('wallet-page');
        }).catch(err => alert("Error: " + err.message));
    }

    function loadWithdrawPage() {
        if (!currentUserData) return;
        const formatBalance = (val) => `11${parseFloat(val || 0).toFixed(2)}`;
        const minWithdraw = appConfig?.paymentSettings?.minWithdraw || 100;
        document.getElementById('withdraw-winnings-balance').textContent = formatBalance(currentUserData.winnings);
        document.getElementById('withdraw-min-amount').textContent = formatBalance(minWithdraw);

        const container = document.getElementById('withdraw-methods-container');
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading methods...</p>';

        db.ref('withdrawMethods').once('value', snapshot => {
            container.innerHTML = ''; 
            if (!snapshot.exists()) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No withdrawal methods available right now.</p>';
                return;
            }

            snapshot.forEach(child => {
                const method = child.val(); 
                const methodId = child.key;
                const option = document.createElement('div');
                option.className = 'payment-method-option';
                option.dataset.methodId = methodId;
                option.innerHTML = `<img src="${method.logo}" alt="${method.name}"><span>${method.name}</span>`;
                option.onclick = () => {
                    document.querySelectorAll('.payment-method-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedWithdrawMethod = method.name;
                    document.getElementById('withdraw-account-label').textContent = `${method.name} Number`;
                    document.getElementById('withdraw-account-input').placeholder = `Enter your ${method.name} number`;
                    document.getElementById('withdraw-account-input').value = '';
                };
                container.appendChild(option);
            });
        }).catch(error => {
            console.error("Error fetching withdraw methods:", error);
            container.innerHTML = '<p style="text-align: center; color: var(--danger-red);">Could not load methods. Please try again.</p>';
        });
    }

    function processWithdrawRequest() {
        if (!currentUserData) return alert("Loading user data...");
        const minWithdraw = appConfig?.paymentSettings?.minWithdraw || 100;
        
        const amount = parseFloat(document.getElementById('withdraw-amount-input').value);
        const accountNumber = document.getElementById('withdraw-account-input').value.trim();

        if (!selectedWithdrawMethod) return alert("Please select a withdrawal method.");
        if (isNaN(amount) || amount < minWithdraw) return alert(`Minimum withdrawal amount is 11${minWithdraw}.`);
        if (amount > currentUserData.winnings) return alert("Withdrawal amount cannot exceed your winnings balance.");
        if (!accountNumber) return alert("Please enter your account details.");

        const requestData = {
            userId: auth.currentUser.uid, userName: currentUserData.name, amount: amount,
            accountNumber: accountNumber, method: selectedWithdrawMethod, status: 'pending',
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        const updates = {};
        updates[`/users/${auth.currentUser.uid}/winnings`] = currentUserData.winnings - amount;
        updates[`/users/${auth.currentUser.uid}/walletBalance`] = currentUserData.walletBalance - amount;
        updates[`/withdrawRequests/${db.ref('withdrawRequests').push().key}`] = requestData;
        
        db.ref().update(updates).then(() => {
            db.ref(`userTransactions/${auth.currentUser.uid}`).push({ amount: -amount, details: `Withdrawal Request via ${selectedWithdrawMethod}`, timestamp: firebase.database.ServerValue.TIMESTAMP });
            alert("Your withdrawal request has been sent successfully. It will be processed shortly.");
            navigateTo('wallet-page');
        }).catch(err => alert("Error: " + err.message));
    }
    
    function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '<p style="text-align:center; padding: 20px;">Loading Leaderboard...</p>';
        db.ref('users').orderByChild('lifetimeWinning').limitToLast(50).once('value', snapshot => {
            if (!snapshot.exists()) { list.innerHTML = '<p style="text-align:center; padding: 20px;">Leaderboard is empty.</p>'; return; }
            const players = [];
            snapshot.forEach(child => { players.push(child.val()); });
            players.reverse();
            list.innerHTML = '';
            players.forEach((player, index) => {
                const rank = index + 1;
                const item = document.createElement('div');
                item.className = `leaderboard-item rank-${rank <= 3 ? rank : 'other'}`;
                const avatarUrl = player.profilePicUrl || DEFAULT_AVATAR;
                item.innerHTML = `<div class="rank-circle">${rank}</div><div class="leaderboard-info"><h4>${player.name}</h4><p>Winnings: 11${(player.lifetimeWinning || 0).toFixed(2)}</p></div><img src="${avatarUrl}" style="width: 45px; height: 45px; border-radius: 50%; margin-left: auto; object-fit: cover;">`;
                list.appendChild(item);
            });
        });
    }

    function loadMyMatches() {
        const container = document.getElementById('my-matches-container');
        const noMatchesDiv = document.getElementById('no-my-matches');
        container.innerHTML = '<p style="text-align:center; padding: 20px;">Loading your matches...</p>';
        noMatchesDiv.classList.add('hidden');
        
        const userId = auth.currentUser.uid;
        if (!userId) return;

        db.ref('tournaments').once('value', snapshot => {
            const joinedMatches = [];
            if (snapshot.exists()) {
                snapshot.forEach(tourSnap => {
                    const tournament = tourSnap.val();
                    const tourId = tourSnap.key;
                    if (tournament.matches) {
                        Object.entries(tournament.matches).forEach(([matchId, match]) => {
                            if (match.joinedPlayers && match.joinedPlayers[userId] && !localHiddenMatches.includes(matchId)) {
                                joinedMatches.push({ tourId, matchId, ...match });
                            }
                        });
                    }
                });
            }

            container.innerHTML = '';
            Object.values(countdownIntervals).forEach(clearInterval);
            countdownIntervals = {};

            if (joinedMatches.length === 0) {
                 noMatchesDiv.classList.remove('hidden');
                 container.appendChild(noMatchesDiv);
            } else {
                joinedMatches.sort((a, b) => new Date(b.date) - new Date(a.date));
                joinedMatches.forEach(match => {
                    container.appendChild(createMatchCard(match.tourId, match.matchId, match, true));
                });
            }
        });
    }

    function loadTransactionHistory() {
        const container = document.getElementById('transaction-list-container');
        const noTransDiv = document.getElementById('no-transactions');
        container.innerHTML = '<p style="text-align:center; padding: 20px;">Loading transactions...</p>';
        noTransDiv.classList.add('hidden');

        const userId = auth.currentUser.uid;
        
        db.ref(`userTransactions/${userId}`).orderByChild('timestamp').limitToLast(50).on('value', snapshot => {
            container.innerHTML = '';
            if (!snapshot.exists()) { noTransDiv.classList.remove('hidden'); container.appendChild(noTransDiv); return; }
            const transactions = [];
            snapshot.forEach(child => { transactions.push(child.val()); });
            transactions.reverse();
            transactions.forEach(tx => {
                const isCredit = tx.amount > 0;
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = `<div class="transaction-icon ${isCredit ? 'credit' : 'debit'}"><i class="material-icons">${isCredit ? 'arrow_downward' : 'arrow_upward'}</i></div><div class="transaction-details"><p>${tx.details}</p><span>${new Date(tx.timestamp).toLocaleString()}</span></div><span class="transaction-amount ${isCredit ? 'credit' : 'debit'}">${isCredit ? '+' : ''}11${Math.abs(tx.amount).toFixed(2)}</span>`;
                container.appendChild(item);
            });
        });
    }
</script>
</body>
</html>